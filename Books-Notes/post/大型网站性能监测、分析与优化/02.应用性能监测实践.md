# 02.应用性能监测实践

**应用性能监测类型**

| 监测数据 | 说明 | 价值 | 最佳监测渠道 |
| :------: | :------ | :------: | :------ |
终端用户 | 无论是PC还是移动产品，监测到各终端产品形态的真实用户使用体验是最有意义的。基本决定了应用性能管理的高度和成败，但实现代价和成本最高 | 高 | PC客户端，移动SOK, JS埋点，第三方厂商
浏览器 | PC、移动各浏览器及版本、各分辨率性能，用户中存在大量“小白”用户，低性能手机及浏览器用户是需要重视和区分对待的 | 低 | PC客户端，移动SOK, JS埋点，第三方厂商
网络 | PC端的宽带网络，例如网络运营商、各种本地网接入的用户是非常复杂的，而窄带移动网络及历史背景更复杂，可以说在中国不能驾驭网络的企业做不好用户体验 | 高 | PC客户端，移动SOK, 第三方厂商
服务器及应用 | 主要指在服务器上的操作系统及运行的各种开发语言开发的后端应用服务性能，包含关联的第三方应用，这一块是性能优化的中后期的主 “战场” | 高 | Agent, 日志，第三方厂商
操作系统 | PC、移动各形态产品运行在不同操作系统上，对性能的影响也是非常紧密的，特别是低性能高负载、有恶意软件及存在劫持、操作系统被定制过的环境等 | 低 | PC客户端，移动SOK, 第三方厂商
厂商 | 主要指移动手机厂商，不同厂商在不同型号手机上的运行操作系统。除了定制、个性化外，APP的性能也是存在差别的，包括兼容性、稳定性等。很多PC厂商的DIY原装系统也是性能杀手 | 低 | PC客户端，移动SOK, 第三方厂商
日志 | 日志里除了用户到服务端及服务端到用户两段路径部分网络指标没有以外，其他信息基本—应俱全，特别是分析后端的性能、全量用户的性能是非常重要的作用 | 高 | 日志，第三方厂商
竞品 | 知己知彼是非常重要的。同类产品，用户体验比竞品优秀本身就是一种竞争力，BAT多年都在不遗余力地追求用户体验行业第一。通过竞品分析，可以知道前端、后端、网络、架构等诸多信息，用来扬长避短 | 低 | PC客户端，第三方厂商

**应用性能监测实现步骤**

- 采集数据

![](http://cdn-blog.liusixin.cn/WX20180821-162222@2x.png)

- 分析数据
- 形成决策

**应用性能监测模式**

按用户触发主要分为主动与被动监测。

- 主动监测。即不依赖真实用户访问，通过抽样用户或IDC环境，主动访问或模拟访问服务，得到各维度应用性能数据。这类监测是属千较小抽样监测，失真度较大，主要用来判断基本的应用性能状态。如果我们用人的健康来帮助理解，也就是说主动监测只能拿到较粗扩虳生命体征状态，例如是否生病，而监测不到生什么病。而且监测频率是人为指定的，例如可用性监测，PC真机监测等，这类监测好处是不需要对产品做额外的嵌码或产生干扰。
- 被动监测。主要指真实用户在使用产品过程中产生的应用性能数据，并触发监测采集规则，将数据返回数据中心，这类数据最真实，而且抽样率可以人为控制，多少都可以指定，真实用户数据抽样率越大，数据越接近真实用户体验。例如移动SOK监测，所有JS类监测都是被动监测，往往这类监测会需要对产品做额外的嵌码并产生少量干扰。从日志中分析用户性能也属千被动监测，曰志分析受日志规模和分析能力影响，时效性较难保障。

## 应用性能持续监测

**持续监测的基本特性**

1. 覆盖PC、移动、网络、系统、应用最完整的应用性能管理，适用千应用研发、测试和交付运维的整个生命周期，并支持Saas化。
2. 主动、被动监测最终用户应用性能及可用性。深入了解真实用户的行为，以便快速而有针对性地解决问题，并最终提升用户体验。
3. 提高可见性就等于改进应用，提供数十种移动、操作系统、应用、公有云等应用性能解决方案，统一视图帮助一览整体性能状态。
4. 定制和交付最终用户视角衡量业务应用性能监测体系，所有维度数据可以集成汇聚到企业系统，洞悉用户性能全局。

**持续监测分类**

1. 移动监测，移动应用性能监测主要分为Native App SOK监测(iOS、Android)、Web App JS监测、移动真机监测三类。移动真机监测只有大的互联网企业才会搭建，即在全国分布的真实手机上持续监测移动应用的性能。不过，目前只有真机监测才可以监测竞争对手的性能，其他监测都做不到，详细内容会在后面章节介绍。
2. PC监测，与移动应用对应，泛指所有PC产品相关监测，主要分为PC Web真机监测（网页、文件）、PC JS监测、网络监测、真机流媒体监测、JS流媒体监测、可用性监测等，以上类型PC监测所有数据均来自产品真实用户。
3. 系统监测，服务器及操作系统性能监测，这里要强调的是系统监测—定要秒级，这样才可以看到细微的系统级性能数据。系统监测可以通过每台服务器的监测数据汇总IDC带宽、业务模块访问量、各模块之间的上下游数据流等数据，使用场景主要是为自有服务器、自建私有云及公有云环境，操作系统主要为CentOS、RedHat、Ubuntu、Windows等。
4. 应用监测，主要分为语言类和第三方平台类，语言类应用监测主要有Java、.NET、PHP、Node.js、Ruby、Python等监测。第三方平台类主要为MySQL、Redis、Tomcat、Docker等。

### 移动监测

**移动监测分类及对比**

- 移动Web App监测

**Web App监测实现原理**

- 监测端的页面核心性能指标收集，利用了W3C正式发布的`NavigationTiming`规范，达到了最精确的等级。这个规范已经被所有的现代浏览器实现，能够在所有智能手机浏览器中使用。通过JS监测可以得到很多性能指标，需要理解这些指标项的真正含义，从而分析出问题所在，并做出有效的优化。`NavigationTiming`记录的所有浏览器事件和时序，被总结成—张顺序图，清晰地展示了浏览器打开—个网页的大部分细节。

![](http://cdn-blog.liusixin.cn/WX20180821-164446@2x.png)

> Navigation Timing指标及含义

| 指标 | 含义 |
| :----- | :----- |
`navigationStart` | 准备加载页面的起始时间
`unloadEventStart` | 如果前一个文档和当前文档同源，返回前一个文档开始unload的时间
`unloadEventEnd` | 如果前—个文档和当前文档同源，返回前—个文档unload结束的时间
`redirectStart` | 如果有重定向，这里是重定向开始的时间
`redirectEnd` | 如果有重定向，这里是重定向结束的时间
`fetchStart` | 开始检查缓存或开始获取资源的时间
`domainlookupStart` | 开始进行DNS查询的时间
`domainlookupEnd` | DNS查询结束的时间
`connectStart` | 开始建立连接请求资源的时间
`connectEnd` | 建立连接成功的时间
`secureConnectionStart` | 如果是HTTPS请求，返回SSL握手的时间
`requestStart` | 开始请求文档时间（包括从服务器、本地缓存请求）
`responseStart` | 接收到第一个字节的时间
`responseEnd` | 接收到最后一个字节的时间
`damLoading` | loading的时间（这个时候还没有开始解析文档）
`dominteractive` | 文档解析结束的时间
`domContentLoadedEventStart` | DOMContentloaded事件开始的时间
`domContentloadedEventEnd` | DOMContentLoaded事件结束的时间
`domComplete` | complete的时间
`loadEventStart` | 触发onload事件的时间
`loadEventEnd` | onload事件结束的时间

- 浏览器的JavaScript API监测，现代Web应用采用了大量新的浏览器API, 比如说Ajax请求。＂监测端“ 利用了较新的浏览器中`Obect.defineProperty`接口，实现对大多数浏览器API调用的代理和监控。这样既不影响应用代码的正常运行，同时不需要开发者为了监测额外进行适配。
- 传统的时间戳收集和回传方法，在使用现代浏览器的新特性同时，监测JavaScript支持传统实现中的时间戳收集方式，在“首字节时间”、“白屏时间” 等指标上达到了最大兼容性和覆盖面。并且通过对图片元素注册事件监听，安全有效地实现“ 首屏时间” 等指标收集。在数据回传上也根据浏览器环境使用多种回传接口，确保数据在各种条件下完整高速回传。
- 配置下发模块使用CON加速，可以允许任务管理模块动态地更新监测配置，并通过缓存刷新、设置过期时间等内部API, 以分钟级速度下发大流量的配置。

- 移动Native App监测
- 移动端到端真机监测